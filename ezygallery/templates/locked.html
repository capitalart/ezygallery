{# Gallery of all finalised artworks with edit and export actions. #}
{% extends "main.html" %}
{% block title %}Locked Artworks{% endblock %}
{% block content %}
<h1>Locked Artworks</h1>
<p class="help-tip">These artworks are locked and cannot be edited until unlocked.</p>
<div class="view-toggle">
  <button id="grid-view-btn" class="btn-small">Grid</button>
  <button id="list-view-btn" class="btn-small">List</button>
</div>
{% if not artworks %}
  <p>No artworks have been finalised yet. Come back after you approve some beautiful pieces!</p>
{% else %}
<div class="finalised-grid">
  {% for art in artworks %}
  <div class="final-card">
    <div class="card-thumb">
      {% if art.main_image %}
      <a href="{{ url_for('artwork.finalised_image', seo_folder=art.seo_folder, filename=art.main_image) }}" class="final-img-link" data-img="{{ url_for('artwork.finalised_image', seo_folder=art.seo_folder, filename=art.main_image) }}">
        <img src="{{ url_for('artwork.finalised_image', seo_folder=art.seo_folder, filename=art.main_image) }}" class="card-img-top" alt="{{ art.title }}">
      </a>
      {% else %}
      <img src="{{ url_for_static('static', filename='img/no-image.svg') }}" class="card-img-top" alt="No image">
      {% endif %}
    </div>
    <div class="card-details">
      <div class="file-name" title="{{ art.filename }}">{{ art.filename }}</div>
      <div class="card-title">{{ art.title }} <span class="locked-badge" title="{{ art.lock_reason }}">Locked</span></div>
      <div class="lock-meta">Locked by {{ art.locked_by }} on {{ art.locked_at }}{% if art.lock_reason %} â€“ {{ art.lock_reason }}{% endif %}</div>
      <div class="desc-snippet" title="{{ art.description }}">
        {{ art.description[:200] }}{% if art.description|length > 200 %}...{% endif %}
      </div>
      <div>SKU: {{ art.sku }}</div>
      <div>Price: {{ art.price }}</div>
      <div>Colours: {{ art.primary_colour }} / {{ art.secondary_colour }}</div>
      <div>SEO: {{ art.seo_filename }}</div>
      <div>Tags: {{ art.tags|join(', ') }}</div>
      <div>Materials: {{ art.materials|join(', ') }}</div>
      {% if art.mockups %}
      <div class="mini-mockup-grid">
        {% for m in art.mockups %}
        <img src="{{ url_for('artwork.finalised_image', seo_folder=art.seo_folder, filename=m.filename) }}" alt="mockup"/>
        {% endfor %}
      </div>
      {% endif %}
      {% if art.images %}
      <details class="img-urls">
        <summary>Image URLs</summary>
        <ul>
          {% for img in art.images %}
          <li>
            <a href="{{ url_for('artwork.finalised_image', seo_folder=art.seo_folder, filename=img.split('/')[-1]) }}" target="_blank">/{{ img }}</a>
          </li>
          {% endfor %}
        </ul>
      </details>
      {% endif %}
    </div>
  <div class="final-actions">
    <a class="btn-black btn-disabled" aria-disabled="true">Edit</a>
    <form method="post" action="{{ url_for('artwork.unlock_listing', aspect=art.aspect, filename=art.filename) }}" class="lock-form" style="display:inline;">
      <input type="hidden" name="reason" value="">
      <button type="submit" class="btn-black">Unlock</button>
    </form>
    <form method="post" action="{{ url_for('artwork.delete_finalised', aspect=art.aspect, filename=art.filename) }}" class="locked-delete-form" style="display:inline;">
      <input type="hidden" name="confirm" value="">
      <button type="submit" class="btn-black btn-danger">Delete</button>
    </form>
  </div>
  </div>
  {% endfor %}
</div>
{% endif %}
<div id="final-modal-bg" class="modal-bg">
  <button id="final-modal-close" class="modal-close" aria-label="Close modal">&times;</button>
  <div class="modal-img"><img id="final-modal-img" src="" alt="Full image"/></div>
</div>
<script>
  document.querySelectorAll('.final-img-link').forEach(link => {
    link.addEventListener('click', function(e){
      e.preventDefault();
      const modal = document.getElementById('final-modal-bg');
      const img = document.getElementById('final-modal-img');
      img.src = this.dataset.img;
      modal.style.display = 'flex';
    });
  });
  document.getElementById('final-modal-close').onclick = function(){
    document.getElementById('final-modal-bg').style.display='none';
    document.getElementById('final-modal-img').src='';
  };
  document.getElementById('final-modal-bg').onclick = function(e){
    if(e.target===this){
      this.style.display='none';
      document.getElementById('final-modal-img').src='';
    }
  };
  document.querySelectorAll('.locked-delete-form').forEach(f=>{
    f.addEventListener('submit',function(ev){
      const val=prompt('This listing is locked and will be permanently deleted. Type DELETE to confirm');
      if(val!=='DELETE'){ev.preventDefault();}
      else{this.querySelector('input[name="confirm"]').value='DELETE';}
    });
  });
  document.querySelectorAll('.lock-form').forEach(f=>{
    f.addEventListener('submit',function(ev){
      const r=prompt('Reason for lock/unlock? (optional)');
      if(r!==null) this.querySelector('input[name="reason"]').value=r;
    });
  });
  const gBtn=document.getElementById('grid-view-btn');
  const lBtn=document.getElementById('list-view-btn');
  const grid=document.querySelector('.finalised-grid');
  function apply(v){ if(v==='list'){grid.classList.add('list-view');} else {grid.classList.remove('list-view');} }
  if(gBtn) gBtn.addEventListener('click',()=>{apply('grid'); localStorage.setItem('lockedView','grid');});
  if(lBtn) lBtn.addEventListener('click',()=>{apply('list'); localStorage.setItem('lockedView','list');});
  apply(localStorage.getItem('lockedView')||'grid');
</script>
{% endblock %}
